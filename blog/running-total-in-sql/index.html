<!DOCTYPE html>
<html lang="en">
  <head>
    <title>
      
      Running Total in SQL -
      
      tklarryonline.me
    </title>
    <!-- Icons -->
<link href='/images/favicon.ico' rel='shortcut icon'>
<link href='/images/og.png' rel='image_src'>
<!-- Styles -->
<!-- external's -->
<link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Open+Sans:300italic,700italic,800italic,300,700,800,600&subset=latin,vietnamese' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Open+Sans+Condensed:700&subset=latin,vietnamese' rel='stylesheet' type='text/css'>
<link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
<!-- internal's -->
<link href='/stylesheets/third-parties/bootstrap.min.css' rel='stylesheet' type='text/css' />
<link href='/stylesheets/third-parties/solarized_syntax.css' rel='stylesheet' type='text/css' />
<link href='/stylesheets/third-parties/jquery.pageslide.css' rel='stylesheet' type='text/css' />
<link href='/stylesheets/main.css' rel='stylesheet' type='text/css' />
<!-- Javascript -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src='/javascripts/pd.js' type='text/javascript'></script>
<!-- Meta -->
<meta content='width=device-width, initial-scale=1.0, user-scalable=no' name='viewport'>
<meta content='text/html; charset=utf-8' http-equiv='content-type' />

<!-- it's article -->
<meta property="og:type" content="article" />
<meta property="og:title" content="Running Total in SQL" />
<meta property="og:site_name" content="tklarryonline.me" />
<meta property='og:url' content='http://tklarryonline.me/blog/running-total-in-sql/' />
<meta property='og:description' content="" />
<meta property="og:image" content="http://tklarryonline.me/files/blog/running-total-in-sql/og_image.jpg" />

<!-- - -->
<!-- @TODO add include ga.html -->

  </head>
  <body class="blog-post">
    <div class="unselectable" id="slide-nav">
  <ul>
    
    <li>
      <a href="/">
        <i class="inline fa fa-home"></i>
        <span class="inline">Home</span>
      </a>
    </li>
    
    <li>
      <a href="/work/">
        <i class="inline fa fa-laptop"></i>
        <span class="inline">Work</span>
      </a>
    </li>
    
    <li>
      <a href="/blog/">
        <i class="inline fa fa-lightbulb-o"></i>
        <span class="inline">Blog</span>
      </a>
    </li>
    
    <li>
      <a href="/books/">
        <i class="inline fa fa-book"></i>
        <span class="inline">Bookshelf</span>
      </a>
    </li>
    
    <li>
      <a href="mailto:luan@tklarryonline.me">
        <i class="inline fa fa-envelope-o"></i>
        <span class="inline">Email</span>
      </a>
    </li>
    
  </ul>
</div>

    <div class="main-container container-fluid">
      <a href="#slide-nav" id="nav-toggle">&#9776;</a>
      <div id="blog-post" class="content">
        <div class="post">
          
          <div class="post-header">
          
            <div class="post-header-contents center-block">
              <div class="posted-date">
                written
                <span class="datetime muted" data-time="2016-07-28 01:02:59 +0700">28 Jul 2016</span>
              </div>
              <h1 class="post-title"><a href="/blog/running-total-in-sql/">Running Total in SQL</a></h1>
              <div class="post-excerpt">
</div>
            </div>
          </div>
          <div class="post-content center-block">
            <p>Recently, my Data Analytics team had to produce a cumulative downloads and revenue report for every mobile app in
every store, starting from the apps’ launch dates. Even though it is very easy to finish this task using any data
analytics framework in Python or other languages, we wanted to try it in MySQL and see if it is feasible. As it
turned out, calculating cumulative summary in MySQL (or any other SQL system) is possible, yet challenging and fun.</p>

<p>Let’s cut the chase, here is the sample structure of our database table named <code class="highlighter-rouge">app_daily</code>:</p>

<table>
  <thead>
    <tr>
      <th>app_name</th>
      <th>store</th>
      <th>country</th>
      <th>start_date</th>
      <th>downloads</th>
      <th>revenue</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Hello World</td>
      <td>App Store</td>
      <td>VN</td>
      <td>2016-01-01</td>
      <td>10</td>
      <td>16.5</td>
    </tr>
    <tr>
      <td>Lorem Ipsum</td>
      <td>Google Play</td>
      <td>US</td>
      <td>2016-01-01</td>
      <td>9</td>
      <td>22.67</td>
    </tr>
    <tr>
      <td>Donor</td>
      <td>Amazon</td>
      <td>UK</td>
      <td>2016-01-01</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <td>Hello World</td>
      <td>App Store</td>
      <td>US</td>
      <td>2016-01-02</td>
      <td>19</td>
      <td>31.35</td>
    </tr>
    <tr>
      <td>Lorem Ipsum</td>
      <td>Google Play</td>
      <td>UK</td>
      <td>2016-01-02</td>
      <td>12</td>
      <td>30.23</td>
    </tr>
    <tr>
      <td>Donor</td>
      <td>Amazon</td>
      <td>VN</td>
      <td>2016-01-02</td>
      <td>18</td>
      <td>53.82</td>
    </tr>
  </tbody>
</table>

<p>The question here — again — is:</p>

<blockquote>
  <p>Find the cumulative downloads and revenue of every app, in every store, starting from launch date (the first date
the app appeared). We don’t need to care about the country.</p>
</blockquote>

<p>Here is the expected result which we want to have:</p>

<table>
  <thead>
    <tr>
      <th>store</th>
      <th>app_name</th>
      <th>start_date</th>
      <th>cumulative_downloads</th>
      <th>cumulative_revenue</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Amazon</td>
      <td>Donor</td>
      <td>2016-01-01</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <td>Amazon</td>
      <td>Donor</td>
      <td>2016-01-02</td>
      <td>19</td>
      <td>53.82</td>
    </tr>
    <tr>
      <td>App Store</td>
      <td>Hello World</td>
      <td>2016-01-01</td>
      <td>10</td>
      <td>16.5</td>
    </tr>
    <tr>
      <td>App Store</td>
      <td>Hello World</td>
      <td>2016-01-02</td>
      <td>29</td>
      <td>47.85</td>
    </tr>
    <tr>
      <td>Google Play</td>
      <td>Lorem Ipsum</td>
      <td>2016-01-01</td>
      <td>9</td>
      <td>22.67</td>
    </tr>
    <tr>
      <td>Google Play</td>
      <td>Lorem Ipsum</td>
      <td>2016-01-02</td>
      <td>21</td>
      <td>52.90</td>
    </tr>
  </tbody>
</table>

<h2 id="how-to-do-it-in-pure-sql">How to do it in pure SQL?</h2>

<p>SQL has many ways to calculate cumulative summary. We will utilize View and Correlated query in our case:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></td><td class="code"><pre><span class="c1">-- Creates a custom View as a shortcut for our initial query</span>
<span class="k">create</span> <span class="k">or</span> <span class="k">replace</span> <span class="k">view</span> <span class="n">ad</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
        <span class="n">store</span><span class="p">,</span>
        <span class="n">app_name</span><span class="p">,</span>
        <span class="n">start_date</span><span class="p">,</span>
        <span class="k">sum</span><span class="p">(</span><span class="n">downloads</span><span class="p">)</span> <span class="k">as</span> <span class="n">downloads</span><span class="p">,</span>
        <span class="k">sum</span><span class="p">(</span><span class="n">revenue</span><span class="p">)</span> <span class="k">as</span> <span class="n">revenue</span>
    <span class="k">from</span> <span class="n">app_daily</span>
    <span class="k">group</span> <span class="k">by</span> <span class="n">store</span><span class="p">,</span> <span class="n">app_name</span><span class="p">,</span> <span class="n">start_date</span>
<span class="p">);</span>

<span class="c1">-- Calculates Cumulative summary</span>
<span class="k">select</span> <span class="n">t</span><span class="p">.</span><span class="n">store</span><span class="p">,</span>
    <span class="n">t</span><span class="p">.</span><span class="n">app_name</span><span class="p">,</span>
    <span class="n">t</span><span class="p">.</span><span class="n">start_date</span><span class="p">,</span>

    <span class="p">(</span>
        <span class="k">select</span> <span class="k">sum</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">downloads</span><span class="p">)</span>
        <span class="k">from</span> <span class="n">ad</span> <span class="n">x</span>
        <span class="k">where</span> <span class="n">x</span><span class="p">.</span><span class="n">start_date</span> <span class="o">&lt;=</span> <span class="n">t</span><span class="p">.</span><span class="n">start_date</span>
        <span class="k">and</span> <span class="n">x</span><span class="p">.</span><span class="n">app_name</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">app_name</span>
        <span class="k">and</span> <span class="n">x</span><span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">store</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">cumulative_downloads</span><span class="p">,</span>

    <span class="p">(</span>
        <span class="k">select</span> <span class="k">sum</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">revenue</span><span class="p">)</span>
        <span class="k">from</span> <span class="n">ad</span> <span class="n">x</span>
        <span class="k">where</span> <span class="n">x</span><span class="p">.</span><span class="n">start_date</span> <span class="o">&lt;=</span> <span class="n">t</span><span class="p">.</span><span class="n">start_date</span>
        <span class="k">and</span> <span class="n">x</span><span class="p">.</span><span class="n">app_name</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">app_name</span>
        <span class="k">and</span> <span class="n">x</span><span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">store</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">cumulative_revenue</span>

<span class="k">from</span> <span class="n">ad</span> <span class="n">t</span>

<span class="k">order</span> <span class="k">by</span> <span class="n">store</span><span class="p">,</span> <span class="n">app_name</span><span class="p">,</span> <span class="n">start_date</span><span class="p">;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><strong>Pros:</strong></p>

<ul>
  <li>Portable in every SQL system.</li>
</ul>

<p><strong>Cons:</strong></p>

<ul>
  <li>Have to create a View. May need to clean up that View when everything is done.</li>
  <li>Have to do correlated query twice.</li>
  <li>Take a long time to run if the table is very big because each correlated query had to calculate again and again.</li>
</ul>

<h2 id="how-to-do-it-in-mysql">How to do it in MySQL?</h2>

<p>MySQL has a very powerful variable system. This query below will make good use of that.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40</pre></td><td class="code"><pre><span class="k">select</span> <span class="n">ad</span><span class="p">.</span><span class="n">store</span><span class="p">,</span>
    <span class="n">ad</span><span class="p">.</span><span class="n">app_name</span><span class="p">,</span>
    <span class="n">ad</span><span class="p">.</span><span class="n">start_date</span><span class="p">,</span>

    <span class="c1">-- Checks if the current row is still for the same app and store</span>
    <span class="c1">-- If not, resets the cumulative_sum</span>
    <span class="o">@</span><span class="n">downloads_total</span> <span class="p">:</span><span class="o">=</span> <span class="n">if</span><span class="p">(</span>
        <span class="o">@</span><span class="n">prev_app</span> <span class="o">=</span> <span class="n">ad</span><span class="p">.</span><span class="n">app_name</span> <span class="k">and</span> <span class="o">@</span><span class="n">prev_store</span> <span class="o">=</span> <span class="n">ad</span><span class="p">.</span><span class="n">store</span><span class="p">,</span>
        <span class="o">@</span><span class="n">downloads_total</span><span class="p">,</span>
        <span class="mi">0</span>
    <span class="p">)</span> <span class="o">+</span> <span class="n">ad</span><span class="p">.</span><span class="n">downloads</span> <span class="k">as</span> <span class="n">cumulative_downloads</span><span class="p">,</span>
    <span class="o">@</span><span class="n">revenue_total</span> <span class="p">:</span><span class="o">=</span> <span class="n">if</span><span class="p">(</span>
        <span class="o">@</span><span class="n">prev_app</span> <span class="o">=</span> <span class="n">ad</span><span class="p">.</span><span class="n">app_name</span> <span class="k">and</span> <span class="o">@</span><span class="n">prev_store</span> <span class="o">=</span> <span class="n">ad</span><span class="p">.</span><span class="n">store</span><span class="p">,</span>
        <span class="o">@</span><span class="n">revenue_total</span><span class="p">,</span>
        <span class="mi">0</span>
    <span class="p">)</span> <span class="o">+</span> <span class="n">ad</span><span class="p">.</span><span class="n">revenue</span> <span class="k">as</span> <span class="n">cumulative_revenue</span><span class="p">,</span>

    <span class="c1">-- Assigns the previous app and store again.</span>
    <span class="o">@</span><span class="n">prev_app</span> <span class="p">:</span><span class="o">=</span> <span class="n">ad</span><span class="p">.</span><span class="n">app_name</span><span class="p">,</span>
    <span class="o">@</span><span class="n">prev_store</span> <span class="p">:</span><span class="o">=</span> <span class="n">ad</span><span class="p">.</span><span class="n">store</span>

<span class="k">from</span> <span class="p">(</span>
    <span class="k">select</span> <span class="n">app_name</span><span class="p">,</span>
        <span class="n">store</span><span class="p">,</span>
        <span class="n">start_date</span><span class="p">,</span>
        <span class="k">sum</span><span class="p">(</span><span class="n">downloads</span><span class="p">)</span> <span class="k">as</span> <span class="n">downloads</span><span class="p">,</span>
        <span class="k">sum</span><span class="p">(</span><span class="n">revenue</span><span class="p">)</span> <span class="k">as</span> <span class="n">revenue</span>

    <span class="k">from</span> <span class="n">app_daily</span>
    <span class="k">group</span> <span class="k">by</span> <span class="n">app_name</span><span class="p">,</span> <span class="n">store</span><span class="p">,</span> <span class="n">start_date</span>
<span class="p">)</span> <span class="n">ad</span>

<span class="k">join</span> <span class="p">(</span>
    <span class="k">select</span> <span class="o">@</span><span class="n">prev_app</span> <span class="p">:</span><span class="o">=</span> <span class="s1">''</span><span class="p">,</span>
        <span class="o">@</span><span class="n">prev_store</span> <span class="p">:</span><span class="o">=</span> <span class="s1">''</span><span class="p">,</span>
        <span class="o">@</span><span class="n">downloads_total</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="o">@</span><span class="n">revenue_total</span> <span class="p">:</span><span class="o">=</span> <span class="mi">0</span>
<span class="p">)</span> <span class="n">vars</span>

<span class="k">order</span> <span class="k">by</span> <span class="n">store</span><span class="p">,</span> <span class="n">app_name</span><span class="p">,</span> <span class="n">start_date</span><span class="p">;</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p><strong>Pros</strong>:</p>

<ul>
  <li>
    <p>Faster than the pure SQL way, because we can reuse the variables’ values and don’t have to recalculate
every time like how the correlated query did.</p>

    <p>In our production table which has 2,981,651 rows — at the writing time — the running time is 2.87 times
  faster than the pure SQL method.</p>
  </li>
  <li>
    <p>Only one query to do the trick.</p>
  </li>
</ul>

<p><strong>Cons</strong>:</p>

<ul>
  <li>Only applicable in MySQL. Incompatible with other SQL systems.</li>
  <li>Have two extra columns which need to be deleted after having the resulting table.</li>
</ul>

            <div class="post-signoff"><p>
  Till next time ;)<br/>
  Luan Nguyen Thanh<br/>
  <span class="muted">01:02 AM</span>
</p>
</div>
          </div>
        </div>

        
<div class="block disqus-thread-container">
  <div id="disqus_thread" class="center-block"></div>
  <script type="text/javascript">
      var disqus_shortname = "tklarryonline";
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

      </div>
    </div>
    <footer>
  <div id="footer" class="center-block general-wrapper720 text-center">
    <p>
      Built with
      <a href="/blog/switching-to-jekyll/">love</a>
      using
      <a href="http://jekyllrb.com/">Jekyll</a>
    </p>
    <p>
      Open sourced
      <a href="https://github.com/tklarryonline/tklarryonline.github.io">on GitHub</a>
      by
      <a href="https://github.com/tklarryonline/">tklarryonline</a>
    </p>
    <p class="social-links">
      
      <a href="http://www.flickr.com/photos/tklarryonline" target="_blank" class="social-link"
        title="flickr">
        <i class="fa fa-flickr"></i>
      </a>
      
      <a href="https://github.com/tklarryonline/" target="_blank" class="social-link"
        title="github">
        <i class="fa fa-github-square"></i>
      </a>
      
      <a href="http://www.linkedin.com/in/tklarryonline" target="_blank" class="social-link"
        title="linkedin">
        <i class="fa fa-linkedin-square"></i>
      </a>
      
    </p>
  </div>
</footer>

    <script src='/javascripts/jquery.pageslide.min.js' type='text/javascript'></script>
<script src='//cdnjs.cloudflare.com/ajax/libs/jquery-backstretch/2.0.4/jquery.backstretch.min.js' type='text/javascript'></script>
<script src='/javascripts/main.js' type='text/javascript'></script>
<script>
    $("#nav-toggle").pageslide();
</script>

  </body>
</html>
